#!/bin/bash
# overwatch-tmux - Launcher script for overwatch in a tmux pane
# Called by Claude Code SessionStart hook

# Only run if inside tmux
if [ -z "$TMUX" ]; then
    exit 0
fi

# Only run if in a git repo
if ! git rev-parse --show-toplevel >/dev/null 2>&1; then
    exit 0
fi

REPO_ROOT=$(git rev-parse --show-toplevel)

# Don't open if no modified files
MODIFIED=$(cd "$REPO_ROOT" && git diff --name-only HEAD 2>/dev/null && git ls-files --others --exclude-standard 2>/dev/null)
if [ -z "$MODIFIED" ]; then
    exit 0
fi

# Check if an overwatch pane is already running
EXISTING=$(tmux list-panes -F '#{pane_id} #{pane_title}' 2>/dev/null | grep "overwatch" | head -1)
if [ -n "$EXISTING" ]; then
    exit 0
fi

# Open a new pane to the right, 40% width, with overwatch
tmux split-window -h -l '40%' "export PATH=\"$HOME/.local/bin:\$PATH\"; overwatch '${REPO_ROOT}'"

# Set the new pane title for identification
tmux select-pane -t '{right}' -T "overwatch"

# Return focus to the left pane (Claude Code)
tmux select-pane -t '{left}'
